<div class="employee-form-container" *ngIf="!isLoading; else loading">
  <!-- Progress Section -->
  <div class="progress-container">
    <div class="progress-header">
      <h1 class="form-title">
        {{ isEditMode ? 'Edit Employee' : 'Add New Employee' }}
        <span class="edit-badge" *ngIf="isEditMode">Editing Mode</span>
      </h1>
      <div class="completion-badge">
        {{ getCompletionPercentage() }}% Complete
      </div>
    </div>

    <!-- Progress Steps -->
    <div class="progress-steps">
      <div *ngFor="let section of formSections" 
           class="step-item"
           [class.active]="currentStep === section.id"
           [class.completed]="section.completed"
           (click)="goToStep(section.id)">
        <nb-icon [icon]="section.icon" class="step-icon"></nb-icon>
        <p class="step-title">{{ section.title }}</p>
      </div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="(currentStep / totalSteps) * 100"></div>
    </div>
  </div>

  <!-- Form Content -->
  <div class="form-content">
    <form [formGroup]="employeeForm" (ngSubmit)="save()">
      <!-- Step 1: Basic Info -->
      <div *ngIf="currentStep === 1">
        <div class="section-header">
          <h2 class="section-title">
            <nb-icon icon="person-outline"></nb-icon>
            Basic Information
          </h2>
          <p class="section-description">Fill in the employee's basic details</p>
        </div>

        <div class="responsive-grid">
          <!-- Employee Code -->
          <div class="form-group">
            <label class="required">Employee Code</label>
            <div class="form-field">
              <nb-icon icon="hash-outline" class="field-icon"></nb-icon>
              <input nbInput 
                     fullWidth 
                     formControlName="employeeCode" 
                     placeholder="EMP001"
                     class="has-icon"
                     [class.is-invalid]="isFieldInvalid('employeeCode')">
            </div>
            <div class="error-message" *ngIf="isFieldInvalid('employeeCode')">
              <nb-icon icon="alert-circle-outline"></nb-icon>
              {{ getErrorMessage('employeeCode') }}
            </div>
          </div>

          <!-- First Name -->
          <div class="form-group">
            <label class="required">First Name</label>
            <div class="form-field">
              <nb-icon icon="user-outline" class="field-icon"></nb-icon>
              <input nbInput 
                     fullWidth 
                     formControlName="firstName" 
                     placeholder="John"
                     class="has-icon"
                     [class.is-invalid]="isFieldInvalid('firstName')">
            </div>
            <div class="error-message" *ngIf="isFieldInvalid('firstName')">
              <nb-icon icon="alert-circle-outline"></nb-icon>
              {{ getErrorMessage('firstName') }}
            </div>
          </div>

          <!-- Middle Name -->
          <div class="form-group">
            <label>Middle Name</label>
            <input nbInput 
                   fullWidth 
                   formControlName="middleName" 
                   placeholder="Middle name (optional)">
          </div>

          <!-- Last Name -->
          <div class="form-group">
            <label class="required">Last Name</label>
            <div class="form-field">
              <nb-icon icon="user-outline" class="field-icon"></nb-icon>
              <input nbInput 
                     fullWidth 
                     formControlName="lastName" 
                     placeholder="Doe"
                     class="has-icon"
                     [class.is-invalid]="isFieldInvalid('lastName')">
            </div>
            <div class="error-message" *ngIf="isFieldInvalid('lastName')">
              <nb-icon icon="alert-circle-outline"></nb-icon>
              {{ getErrorMessage('lastName') }}
            </div>
          </div>

          <!-- Date of Joining -->
          <div class="form-group">
            <label class="required">Date of Joining</label>
            <div class="form-field">
              <nb-icon icon="calendar-outline" class="field-icon"></nb-icon>
              <input nbInput 
                     fullWidth 
                     type="date" 
                     formControlName="dateOfJoining"
                     class="has-icon"
                     [class.is-invalid]="isFieldInvalid('dateOfJoining')">
            </div>
            <div class="error-message" *ngIf="isFieldInvalid('dateOfJoining')">
              <nb-icon icon="alert-circle-outline"></nb-icon>
              {{ getErrorMessage('dateOfJoining') }}
            </div>
          </div>

          <!-- Aadhar Number -->
          <div class="form-group">
            <label>Aadhar Number</label>
            <div class="form-field">
              <nb-icon icon="id-card-outline" class="field-icon"></nb-icon>
              <input nbInput 
                     fullWidth 
                     formControlName="aadharNo" 
                     placeholder="1234 5678 9012"
                     class="has-icon"
                     maxlength="12"
                     [class.is-invalid]="isFieldInvalid('aadharNo')">
            </div>
            <div class="error-message" *ngIf="isFieldInvalid('aadharNo')">
              <nb-icon icon="alert-circle-outline"></nb-icon>
              {{ getErrorMessage('aadharNo') }}
            </div>
          </div>

          <!-- Email -->
          <div class="form-group">
            <label>Email Address</label>
            <div class="form-field">
              <nb-icon icon="email-outline" class="field-icon"></nb-icon>
              <input nbInput 
                     fullWidth 
                     type="email" 
                     formControlName="emailId" 
                     placeholder="john.doe@company.com"
                     class="has-icon"
                     [class.is-invalid]="isFieldInvalid('emailId')">
            </div>
            <div class="error-message" *ngIf="isFieldInvalid('emailId')">
              <nb-icon icon="alert-circle-outline"></nb-icon>
              {{ getErrorMessage('emailId') }}
            </div>
          </div>

          <!-- Status -->
          <div class="form-group">
            <label>Status</label>
            <nb-toggle formControlName="activeStatus">
              <span class="toggle-label">
                <nb-icon icon="checkmark-circle-outline" *ngIf="employeeForm.get('activeStatus')?.value"></nb-icon>
                <nb-icon icon="close-circle-outline" *ngIf="!employeeForm.get('activeStatus')?.value"></nb-icon>
                {{ employeeForm.get('activeStatus')?.value ? 'Active' : 'Inactive' }}
              </span>
            </nb-toggle>
          </div>
        </div>
      </div>

      <!-- Step 2: Addresses -->
      <div *ngIf="currentStep === 2">
        <div class="form-array-section">
          <div class="section-header">
            <h2 class="section-title">
              <nb-icon icon="home-outline"></nb-icon>
              Address Details
            </h2>
            <button nbButton 
                    type="button" 
                    class="add-btn"
                    (click)="addAddress()">
              <nb-icon icon="plus-outline"></nb-icon>
              Add Address
            </button>
          </div>

          <div formArrayName="addresses">
            <div *ngFor="let addr of addresses.controls; let i = index; trackBy: trackByIndex" 
                 [formGroupName]="i"
                 class="array-item-card">
              <div class="card-header">
                <h3 class="card-title">
                  <span class="item-number">{{ i + 1 }}</span>
                  Address {{ i + 1 }}
                </h3>
                <button nbButton 
                        type="button"
                        status="danger"
                        size="small"
                        class="remove-btn"
                        (click)="showDeleteConfirm('address', i)"
                        *ngIf="addresses.length > 1">
                  <nb-icon icon="trash-2-outline"></nb-icon>
                  Remove
                </button>
              </div>

              <div class="card-body">
                <div class="responsive-grid">
                  <div class="form-group">
                    <label>Address Line 1</label>
                    <input nbInput 
                           fullWidth 
                           formControlName="addressLine1" 
                           placeholder="Street address, P.O. box">
                  </div>

                  <div class="form-group">
                    <label>Address Line 2</label>
                    <input nbInput 
                           fullWidth 
                           formControlName="addressLine2" 
                           placeholder="Apartment, suite, unit">
                  </div>

                  <div class="form-group">
                    <label>Address Line 3</label>
                    <input nbInput 
                           fullWidth 
                           formControlName="addressLine3" 
                           placeholder="Landmark, area">
                  </div>

                  <div class="form-group">
                    <label>City</label>
                    <input nbInput 
                           fullWidth 
                           formControlName="city" 
                           placeholder="City/Town">
                  </div>

                  <div class="form-group">
                    <label>Pincode</label>
                    <input nbInput 
                           fullWidth 
                           formControlName="pincode" 
                           placeholder="6-digit pincode"
                           maxlength="6">
                  </div>

                  <div class="form-group">
                    <label>Mobile Number</label>
                    <input nbInput 
                           fullWidth 
                           formControlName="mobile" 
                           placeholder="10-digit mobile number"
                           maxlength="10">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Bank Details -->
      <div *ngIf="currentStep === 3">
        <div class="form-array-section">
          <div class="section-header">
            <h2 class="section-title">
              <nb-icon icon="credit-card-outline"></nb-icon>
              Bank Details
            </h2>
            <button nbButton 
                    type="button" 
                    class="add-btn"
                    (click)="addBank()">
              <nb-icon icon="plus-outline"></nb-icon>
              Add Bank
            </button>
          </div>

          <div formArrayName="banks">
            <div *ngFor="let bank of banks.controls; let i = index; trackBy: trackByIndex" 
                 [formGroupName]="i"
                 class="array-item-card">
              <div class="card-header">
                <h3 class="card-title">
                  <span class="item-number">{{ i + 1 }}</span>
                  Bank Account {{ i + 1 }}
                </h3>
                <button nbButton 
                        type="button"
                        status="danger"
                        size="small"
                        class="remove-btn"
                        (click)="showDeleteConfirm('bank', i)"
                        *ngIf="banks.length > 1">
                  <nb-icon icon="trash-2-outline"></nb-icon>
                  Remove
                </button>
              </div>

              <div class="card-body">
                <div class="responsive-grid">
                  <div class="form-group">
                    <label>Bank Name</label>
                    <input nbInput 
                           fullWidth 
                           formControlName="bankName" 
                           placeholder="Bank name">
                  </div>

                  <div class="form-group">
                    <label>Branch Name</label>
                    <input nbInput 
                           fullWidth 
                           formControlName="branchName" 
                           placeholder="Branch name">
                  </div>

                  <div class="form-group">
                    <label>Account Number</label>
                    <input nbInput 
                           fullWidth 
                           formControlName="accountNo" 
                           placeholder="Account number">
                  </div>

                  <div class="form-group">
                    <label>IFSC Code</label>
                    <input nbInput 
                           fullWidth 
                           formControlName="ifscCode" 
                           placeholder="IFSC code"
                           style="text-transform: uppercase;">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 4: Attributes -->
      <div *ngIf="currentStep === 4">
        <div class="form-array-section">
          <div class="section-header">
            <h2 class="section-title">
              <nb-icon icon="layers-outline"></nb-icon>
              Custom Attributes
            </h2>
            <button nbButton 
                    type="button" 
                    class="add-btn"
                    (click)="addAttribute()">
              <nb-icon icon="plus-outline"></nb-icon>
              Add Attribute
            </button>
          </div>

          <div formArrayName="attributes">
            <div *ngFor="let attrGroup of attributes.controls; let i = index; trackBy: trackByIndex" 
                 [formGroupName]="i"
                 class="array-item-card">
              <div class="card-header">
                <h3 class="card-title">
                  <span class="item-number">{{ i + 1 }}</span>
                  Attribute {{ i + 1 }}
                </h3>
                <button nbButton 
                        type="button"
                        status="danger"
                        size="small"
                        class="remove-btn"
                        (click)="showDeleteConfirm('attribute', i)"
                        *ngIf="attributes.length > 1">
                  <nb-icon icon="trash-2-outline"></nb-icon>
                  Remove
                </button>
              </div>

              <div class="card-body">
                <div class="responsive-grid">
                  <!-- Attribute Selection -->
                  <div class="form-group">
                    <label>Attribute Name</label>
                    <nb-select placeholder="Select Attribute"
                              formControlName="id"
                              (selectedChange)="onAttributeSelected(i)"
                              fullWidth>
                      <nb-option *ngFor="let attr of availableAttributes" [value]="attr.id">
                        {{ attr.attributeName }}
                      </nb-option>
                    </nb-select>
                  </div>

                  <!-- Dynamic Value Field -->
                  <div class="form-group">
                    <label>Attribute Value</label>
                    <ng-container [ngSwitch]="getAttributeType(i)">
                      <!-- Dropdown -->
                      <nb-select *ngSwitchCase="'Dropdown'" 
                                formControlName="value"
                                placeholder="Select value"
                                fullWidth>
                        <nb-option *ngFor="let val of getAttributeValues(i)" [value]="val.value">
                          {{ val.value }}
                        </nb-option>
                      </nb-select>

                      <!-- Date -->
                      <input *ngSwitchCase="'Date'"
                            nbInput
                            type="date"
                            formControlName="value"
                            placeholder="Select date"
                            fullWidth>

                      <!-- Number -->
                      <input *ngSwitchCase="'Number'"
                            nbInput
                            type="number"
                            formControlName="value"
                            placeholder="Enter number"
                            fullWidth>

                      <!-- String/Default -->
                      <input *ngSwitchDefault
                            nbInput
                            formControlName="value"
                            placeholder="Enter value"
                            fullWidth>
                    </ng-container>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 5: Certificates -->
      <div *ngIf="currentStep === 5">
        <div class="form-array-section">
          <div class="section-header">
            <h2 class="section-title">
              <nb-icon icon="file-text-outline"></nb-icon>
              Certificates & Documents
            </h2>
            <button nbButton 
                    type="button" 
                    class="add-btn"
                    (click)="addCertificate()">
              <nb-icon icon="plus-outline"></nb-icon>
              Add Certificate
            </button>
          </div>

          <div formArrayName="certificates">
            <div *ngFor="let cert of certificates.controls; let i = index; trackBy: trackByIndex" 
                 [formGroupName]="i"
                 class="array-item-card">
              <div class="card-header">
                <h3 class="card-title">
                  <span class="item-number">{{ i + 1 }}</span>
                  Certificate {{ i + 1 }}
                </h3>
                <button nbButton 
                        type="button"
                        status="danger"
                        size="small"
                        class="remove-btn"
                        (click)="showDeleteConfirm('certificate', i)"
                        *ngIf="certificates.length > 1">
                  <nb-icon icon="trash-2-outline"></nb-icon>
                  Remove
                </button>
              </div>

              <div class="card-body">
                <div class="responsive-grid">
                  <div class="form-group">
                    <label>Certificate Name</label>
                    <input nbInput 
                           fullWidth 
                           formControlName="certificateName" 
                           placeholder="e.g., Degree Certificate">
                  </div>

                  <div class="form-group">
                    <label>Issuer</label>
                    <input nbInput 
                           fullWidth 
                           formControlName="issuer" 
                           placeholder="Issuing authority">
                  </div>

                  <div class="form-group">
                    <label>Issue Date</label>
                    <input nbInput 
                           fullWidth 
                           type="date" 
                           formControlName="issueDate">
                  </div>

                  <!-- File Upload -->
                  <div class="form-group">
                    <label>Document Upload</label>
                    <div class="file-upload-container">
                      <div class="file-input-wrapper">
                        <input type="file" 
                               class="file-input"
                               (change)="onFileChange($event, i)"
                               accept=".jpg,.jpeg,.png,.pdf">
                        <div class="file-drop-area" [class.has-file]="cert.get('file')?.value">
                          <nb-icon icon="upload-outline" class="upload-icon"></nb-icon>
                          <p class="upload-text">Click to upload or drag & drop</p>
                          <p class="upload-hint">JPEG, PNG or PDF (max 5MB)</p>
                          <div class="file-name" *ngIf="cert.get('file')?.value">
                            <nb-icon icon="checkmark-circle-outline"></nb-icon>
                            {{ cert.get('file')?.value?.name }}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="form-group">
                    <nb-checkbox formControlName="verifiedStatus">
                      Verified
                    </nb-checkbox>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <div class="nav-buttons">
          <button nbButton 
                  type="button"
                  status="basic"
                  class="nav-btn"
                  (click)="prevStep()"
                  [disabled]="currentStep === 1">
            <nb-icon icon="arrow-left-outline"></nb-icon>
            Previous
          </button>
          <button nbButton 
                  type="button"
                  status="basic"
                  class="nav-btn"
                  (click)="nextStep()"
                  [disabled]="currentStep === totalSteps">
            Next
            <nb-icon icon="arrow-right-outline"></nb-icon>
          </button>
        </div>

        <div class="action-buttons">
          <button nbButton 
                  status="danger"
                  type="button"
                  class="cancel-btn"
                  (click)="router.navigate(['/pages/master/employeemaster'])">
            <nb-icon icon="close-outline"></nb-icon>
            Cancel
          </button>
          <button nbButton 
                  status="primary"
                  type="submit"
                  class="save-btn"
                  [disabled]="employeeForm.invalid || isLoading">
            <nb-icon icon="save-outline"></nb-icon>
            {{ isLoading ? 'Saving...' : (isEditMode ? 'Update Employee' : 'Create Employee') }}
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Loading Template -->
<ng-template #loading>
  <div class="loading-overlay">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>{{ isEditMode ? 'Loading employee data...' : 'Preparing form...' }}</p>
    </div>
  </div>
</ng-template>