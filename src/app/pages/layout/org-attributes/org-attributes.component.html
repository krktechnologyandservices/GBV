<!-- Mobile Overlay -->
<div class="mobile-overlay" 
     [class.show-overlay]="isMobileView && (showForm || showDropdownSection)" 
     (click)="showForm = false; showDropdownSection = false;"></div>

<!-- Loading Spinner -->
<nb-spinner *ngIf="isLoading" size="giant" class="overlay-spinner"></nb-spinner>

<div class="container-fluid p-3">
  <!-- Header -->
  <div class="header-container">
    <div class="header-content">
      <div class="title-section">
        <h4>
          <nb-icon icon="layers-outline"></nb-icon>
          Organization Attribute Manager
        </h4>
        <p>Create and manage organization attributes</p>
      </div>
      
      <div class="mobile-actions">
        <button nbButton status="primary" size="small" (click)="showForm = true">
          <nb-icon icon="plus-outline"></nb-icon>
          New Attribute
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content-wrapper">
    <!-- Form Section -->
    <div class="form-section" [class.show-form]="showForm">
      <!-- Mobile Form Header -->
      <div class="form-header" *ngIf="isMobileView">
        <h5>Create New Attribute</h5>
        <button class="close-btn" (click)="showForm = false">
          <nb-icon icon="close-outline"></nb-icon>
        </button>
      </div>

      <!-- Form Title (Desktop) -->
      <h5 class="form-title" *ngIf="!isMobileView">
        <nb-icon icon="plus-circle-outline"></nb-icon>
        Create New Attribute
      </h5>

      <form (ngSubmit)="createAttribute()" class="form-grid">
        <div class="form-row">
          <!-- Attribute Name -->
          <div class="form-group">
            <label>Attribute Name <span class="required">*</span></label>
            <input nbInput
              placeholder="Attribute Name"
              [(ngModel)]="newAttribute.attributeName"
              name="attributeName"
              [status]="!newAttribute.attributeName && isLoading === false ? 'danger' : 'basic'"
              required />
          </div>

          <!-- Data Type -->
          <div class="form-group">
            <label>Data Type</label>
            <nb-select [(ngModel)]="newAttribute.dataType" name="dataType" fullWidth>
              <nb-option *ngFor="let dt of dataTypes" [value]="dt">
                <nb-icon [icon]="getDataTypeIcon(dt)" class="mr-2"></nb-icon>
                {{ dt }}
              </nb-option>
            </nb-select>
          </div>
        </div>

        <div class="form-group">
          <label>Options</label>
          <div class="checkbox-group">
            <nb-checkbox [(ngModel)]="newAttribute.isRequired" name="isRequired">
              Required
            </nb-checkbox>
            <nb-checkbox [(ngModel)]="newAttribute.isUnique" name="isUnique">
              Unique
            </nb-checkbox>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button nbButton status="primary" [disabled]="isLoading" type="submit" class="full-width-mobile">
            <nb-icon [icon]="isLoading ? 'loader-outline' : 'save-outline'"></nb-icon>
            {{ isLoading ? 'Creating...' : 'Create Attribute' }}
          </button>
          
          <div class="spacer"></div>
          
          <button nbButton status="basic" type="button" (click)="resetAttributeForm()" class="full-width-mobile">
            <nb-icon icon="refresh-outline"></nb-icon>
            Reset
          </button>
          
          <button nbButton status="warning" type="button" (click)="showForm = false" *ngIf="isMobileView" class="full-width-mobile">
            <nb-icon icon="arrow-back-outline"></nb-icon>
            Back to List
          </button>
        </div>
      </form>
    </div>

    <!-- List Section -->
    <div class="list-section">
      <div class="list-header">
        <h5>
          Attributes List
          <span class="count-badge">{{ filteredAttributes.length }}</span>
        </h5>
        
        <div class="search-filter">
          <nb-input 
            shape="round" 
            placeholder="Search attributes..."
            [(ngModel)]="searchTerm"
            (ngModelChange)="applySearch()"
            fullWidth
          >
            <nb-icon nbPrefix icon="search-outline"></nb-icon>
          </nb-input>
          
          <nb-select 
            shape="round" 
            [(selected)]="typeFilter"
            (selectedChange)="applySearch()"
            fullWidth
          >
            <nb-option value="all">All Types</nb-option>
            <nb-option *ngFor="let type of dataTypes" [value]="type">{{ type }}</nb-option>
          </nb-select>
        </div>
      </div>

      <!-- Attributes Table -->
      <div class="table-responsive" *ngIf="filteredAttributes.length > 0; else emptyState">
        <table class="attributes-table">
          <thead>
            <tr>
              <th>Attribute</th>
              <th>Properties</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let attr of getPageItems()" 
                [class.selected]="selectedAttribute?.id === attr.id"
                (click)="onSelectAttribute(attr)">
              <td>
                <div class="attribute-info">
                  <div class="attribute-icon">
                    <nb-icon [icon]="getDataTypeIcon(attr.dataType)"></nb-icon>
                  </div>
                  <div class="attribute-details">
                    <h6>{{ attr.attributeName }}</h6>
                    <div class="attribute-meta">
                      <span class="data-type">{{ attr.dataType }}</span>
                    </div>
                  </div>
                </div>
              </td>
              <td>
                <div class="attribute-badges">
                  <span class="status-badge required" *ngIf="attr.isRequired">
                    <nb-icon icon="alert-circle-outline"></nb-icon>
                    Required
                  </span>
                  <span class="status-badge unique" *ngIf="attr.isUnique">
                    <nb-icon icon="checkmark-circle-outline"></nb-icon>
                    Unique
                  </span>
                  <span class="status-badge deleted" *ngIf="attr.isDeleted">
                    <nb-icon icon="trash-outline"></nb-icon>
                    Deleted
                  </span>
                </div>
              </td>
              <td>
                <div class="action-buttons">
                  <button nbButton size="small" status="danger" (click)="deleteAttribute(attr.id!, $event)">
                    <nb-icon icon="trash-2-outline"></nb-icon>
                    <span class="hide-on-mobile">Delete</span>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Pagination -->
        <div class="pagination-container" *ngIf="filteredAttributes.length > itemsPerPage">
          <div class="pagination-info">
            Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to 
            {{ Math.min(currentPage * itemsPerPage, filteredAttributes.length) }} of {{ filteredAttributes.length }} entries
          </div>
          <div class="pagination-controls">
            <button 
              nbButton 
              ghost 
              size="small"
              [disabled]="currentPage === 1"
              (click)="currentPage = currentPage - 1"
            >
              <nb-icon icon="chevron-left-outline"></nb-icon>
            </button>
            <span class="page-number">
              Page {{ currentPage }}
            </span>
            <button 
              nbButton 
              ghost 
              size="small"
              [disabled]="currentPage * itemsPerPage >= filteredAttributes.length"
              (click)="currentPage = currentPage + 1"
            >
              <nb-icon icon="chevron-right-outline"></nb-icon>
            </button>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <ng-template #emptyState>
        <div class="empty-state">
          <nb-icon icon="folder-open-outline"></nb-icon>
          <h5>No attributes found</h5>
          <p *ngIf="searchTerm || typeFilter !== 'all'">
            Try adjusting your search or filter
          </p>
          <p *ngIf="!searchTerm && typeFilter === 'all'">
            Start by creating your first attribute
          </p>
          <button 
            nbButton 
            status="primary" 
            size="small"
            (click)="showForm = true"
            class="mt-3"
          >
            <nb-icon icon="plus-outline"></nb-icon>
            Create Attribute
          </button>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- Dropdown Values Section -->
  <div class="dropdown-section" 
       *ngIf="selectedAttribute?.dataType === 'Dropdown'" 
       [class.show-dropdown-section]="!isMobileView || (isMobileView && showDropdownSection)">
    
    <div class="dropdown-header">
      <h5>
        <nb-icon icon="list-outline"></nb-icon>
        Dropdown Values for {{ selectedAttribute.attributeName }}
      </h5>
      <button *ngIf="isMobileView" class="close-btn" (click)="showDropdownSection = false">
        <nb-icon icon="close-outline"></nb-icon>
      </button>
    </div>

    <div class="value-management">
      <div class="value-input">
        <input nbInput
          placeholder="New dropdown value"
          [(ngModel)]="newDropdownValue"
          [disabled]="isLoading"
          fullWidth />
        <button nbButton status="success" (click)="addDropdownValue()" 
                [disabled]="!newDropdownValue.trim() || isLoading">
          <nb-icon icon="plus-outline"></nb-icon>
          Add Value
        </button>
      </div>

      <div class="values-list" *ngIf="dropdownValues.length > 0; else noValues">
        <div class="value-item" *ngFor="let val of dropdownValues">
          <span>{{ val.value }}</span>
          <button nbButton size="small" status="danger" 
                  (click)="deleteDropdownValue(val.id!, $event)" 
                  [disabled]="isLoading">
            <nb-icon icon="trash-2-outline"></nb-icon>
          </button>
        </div>
      </div>

      <ng-template #noValues>
        <div class="empty-state">
          <nb-icon icon="list-outline"></nb-icon>
          <h5>No dropdown values</h5>
          <p>Add values to create a dropdown list</p>
        </div>
      </ng-template>
    </div>
  </div>
</div>